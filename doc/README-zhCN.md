# Zotero Plugin Template

[![zotero target version](https://img.shields.io/badge/Zotero-7-green?style=flat-square&logo=zotero&logoColor=CC2936)](https://www.zotero.org)
[![Using Zotero Plugin Template](https://img.shields.io/badge/Using-Zotero%20Plugin%20Template-blue?style=flat-square&logo=github)](https://github.com/windingwind/zotero-plugin-template)

è¿™æ˜¯ [Zotero](https://www.zotero.org/) çš„æ’ä»¶æ¨¡æ¿.

[English](../README.md) | [ç®€ä½“ä¸­æ–‡](./README-zhCN.md)

- å¼€å‘æŒ‡å—
  - [ğŸ“– æ’ä»¶å¼€å‘æ–‡æ¡£](https://zotero-chinese.com/plugin-dev-guide/) (ä¸­æ–‡ç‰ˆï¼Œå°šä¸å®Œå–„)
  - [ğŸ“– Zotero 7 æ’ä»¶å¼€å‘æ–‡æ¡£](https://www.zotero.org/support/dev/zotero_7_for_developers)
- å¼€å‘å·¥å…·å‚è€ƒ
  - [ğŸ› ï¸ Zotero æ’ä»¶å·¥å…·åŒ…](https://github.com/windingwind/zotero-plugin-toolkit) | [API æ–‡æ¡£](https://github.com/windingwind/zotero-plugin-toolkit/blob/master/docs/zotero-plugin-toolkit.md)
  - [ğŸ› ï¸ Zotero æ’ä»¶å¼€å‘è„šæ‰‹æ¶](https://github.com/northword/zotero-plugin-scaffold)
  - [ğŸ“œ Zotero æºä»£ç ](https://github.com/zotero/zotero)
  - [â„¹ï¸ Zotero ç±»å‹å®šä¹‰](https://github.com/windingwind/zotero-types)
  - [ğŸ“Œ Zotero æ’ä»¶æ¨¡æ¿](https://github.com/windingwind/zotero-plugin-template) (å³æœ¬ä»“åº“)

> [!tip]
> ğŸ‘ Watch æœ¬ä»“åº“ï¼Œä»¥åŠæ—¶æ”¶åˆ°ä¿®å¤æˆ–æ›´æ–°çš„é€šçŸ¥.

## ä½¿ç”¨æ­¤æ¨¡æ¿æ„å»ºçš„æ’ä»¶

[![GitHub Repo stars](https://img.shields.io/github/stars/windingwind/zotero-better-notes?label=zotero-better-notes&style=flat-square)](https://github.com/windingwind/zotero-better-notes)
[![GitHub Repo stars](https://img.shields.io/github/stars/windingwind/zotero-pdf-preview?label=zotero-pdf-preview&style=flat-square)](https://github.com/windingwind/zotero-pdf-preview)
[![GitHub Repo stars](https://img.shields.io/github/stars/windingwind/zotero-pdf-translate?label=zotero-pdf-translate&style=flat-square)](https://github.com/windingwind/zotero-pdf-translate)
[![GitHub Repo stars](https://img.shields.io/github/stars/windingwind/zotero-tag?label=zotero-tag&style=flat-square)](https://github.com/windingwind/zotero-tag)
[![GitHub Repo stars](https://img.shields.io/github/stars/iShareStuff/ZoteroTheme?label=zotero-theme&style=flat-square)](https://github.com/iShareStuff/ZoteroTheme)
[![GitHub Repo stars](https://img.shields.io/github/stars/MuiseDestiny/zotero-reference?label=zotero-reference&style=flat-square)](https://github.com/MuiseDestiny/zotero-reference)
[![GitHub Repo stars](https://img.shields.io/github/stars/MuiseDestiny/zotero-citation?label=zotero-citation&style=flat-square)](https://github.com/MuiseDestiny/zotero-citation)
[![GitHub Repo stars](https://img.shields.io/github/stars/MuiseDestiny/ZoteroStyle?label=zotero-style&style=flat-square)](https://github.com/MuiseDestiny/ZoteroStyle)
[![GitHub Repo stars](https://img.shields.io/github/stars/volatile-static/Chartero?label=Chartero&style=flat-square)](https://github.com/volatile-static/Chartero)
[![GitHub Repo stars](https://img.shields.io/github/stars/l0o0/tara?label=tara&style=flat-square)](https://github.com/l0o0/tara)
[![GitHub Repo stars](https://img.shields.io/github/stars/redleafnew/delitemwithatt?label=delitemwithatt&style=flat-square)](https://github.com/redleafnew/delitemwithatt)
[![GitHub Repo stars](https://img.shields.io/github/stars/redleafnew/zotero-updateifsE?label=zotero-updateifsE&style=flat-square)](https://github.com/redleafnew/zotero-updateifsE)
[![GitHub Repo stars](https://img.shields.io/github/stars/northword/zotero-format-metadata?label=zotero-format-metadata&style=flat-square)](https://github.com/northword/zotero-format-metadata)
[![GitHub Repo stars](https://img.shields.io/github/stars/inciteful-xyz/inciteful-zotero-plugin?label=inciteful-zotero-plugin&style=flat-square)](https://github.com/inciteful-xyz/inciteful-zotero-plugin)
[![GitHub Repo stars](https://img.shields.io/github/stars/MuiseDestiny/zotero-gpt?label=zotero-gpt&style=flat-square)](https://github.com/MuiseDestiny/zotero-gpt)
[![GitHub Repo stars](https://img.shields.io/github/stars/zoushucai/zotero-journalabbr?label=zotero-journalabbr&style=flat-square)](https://github.com/zoushucai/zotero-journalabbr)
[![GitHub Repo stars](https://img.shields.io/github/stars/MuiseDestiny/zotero-figure?label=zotero-figure&style=flat-square)](https://github.com/MuiseDestiny/zotero-figure)
[![GitHub Repo stars](https://img.shields.io/github/stars/l0o0/jasminum?label=jasminum&style=flat-square)](https://github.com/l0o0/jasminum)
[![GitHub Repo stars](https://img.shields.io/github/stars/lifan0127/ai-research-assistant?label=ai-research-assistant&style=flat-square)](https://github.com/lifan0127/ai-research-assistant)

[![GitHub Repo stars](https://img.shields.io/github/stars/daeh/zotero-markdb-connect?label=zotero-markdb-connect&style=flat-square)](https://github.com/daeh/zotero-markdb-connect)

å¦‚æœä½ æ­£åœ¨ä½¿ç”¨æ­¤åº“ï¼Œæˆ‘å»ºè®®ä½ å°†è¿™ä¸ªæ ‡å¿— ([![Using Zotero Plugin Template](https://img.shields.io/badge/Using-Zotero%20Plugin%20Template-blue?style=flat-square&logo=github)](https://github.com/windingwind/zotero-plugin-template)) æ”¾åœ¨ README æ–‡ä»¶ä¸­:

```md
[![Using Zotero Plugin Template](https://img.shields.io/badge/Using-Zotero%20Plugin%20Template-blue?style=flat-square&logo=github)](https://github.com/windingwind/zotero-plugin-template)
```

## Features ç‰¹æ€§

- äº‹ä»¶é©±åŠ¨ã€å‡½æ•°å¼ç¼–ç¨‹çš„å¯æ‰©å±•æ¡†æ¶ï¼›
- ç®€å•æ˜“ç”¨ï¼Œå¼€ç®±å³ç”¨ï¼›
- â­[æ–°ç‰¹æ€§!]è‡ªåŠ¨çƒ­é‡è½½ï¼æ¯å½“ä¿®æ”¹æºç æ—¶ï¼Œéƒ½ä¼šè‡ªåŠ¨ç¼–è¯‘å¹¶é‡æ–°åŠ è½½æ’ä»¶ï¼›[è¯¦æƒ…è¯·è·³è½¬â†’](#è‡ªåŠ¨çƒ­é‡è½½)
- `src/modules/examples.ts` ä¸­æœ‰ä¸°å¯Œçš„ç¤ºä¾‹ï¼Œæ¶µç›–äº†æ’ä»¶ä¸­å¸¸ç”¨çš„å¤§éƒ¨åˆ†API (ä½¿ç”¨ [zotero-plugin-toolkit](https://github.com/windingwind/zotero-plugin-toolkit)ï¼›
- TypeScript æ”¯æŒ:
  - ä¸ºä½¿ç”¨ JavaScript ç¼–å†™çš„ Zotero æºç æä¾›å…¨é¢çš„ç±»å‹å®šä¹‰æ”¯æŒ (ä½¿ç”¨ [zotero-types](https://github.com/windingwind/zotero-types))ï¼›
  - å…¨å±€å˜é‡å’Œç¯å¢ƒè®¾ç½®ï¼›
- æ’ä»¶å¼€å‘/æ„å»º/å‘å¸ƒå·¥ä½œæµ:
  - è‡ªåŠ¨ç”Ÿæˆ/æ›´æ–°æ’ä»¶ç‰ˆæœ¬ã€æ›´æ–°é…ç½®å’Œè®¾ç½®ç¯å¢ƒå˜é‡ (`development`/`production`)ï¼›
  - è‡ªåŠ¨åœ¨ Zotero ä¸­æ„å»ºå’Œé‡æ–°åŠ è½½ä»£ç ï¼›
  - è‡ªåŠ¨å‘å¸ƒåˆ° GitHub ;
- é›†æˆ Prettier å’Œ ES Lint;

## Examples ç¤ºä¾‹

æ­¤åº“æä¾›äº† [zotero-plugin-toolkit](https://github.com/windingwind/zotero-plugin-toolkit) ä¸­APIçš„ç¤ºä¾‹.

åœ¨ `src/examples.ts` ä¸­æœç´¢`@example` æŸ¥çœ‹ç¤ºä¾‹. è¿™äº›ç¤ºä¾‹åœ¨ `src/hooks.ts` ä¸­è°ƒç”¨æ¼”ç¤º.

### åŸºæœ¬ç¤ºä¾‹(Basic Examples)

- registerNotifier
- registerPrefs, unregisterPrefs

### å¿«æ·é”®ç¤ºä¾‹(Shortcut Keys Examples)

- registerShortcuts
- exampleShortcutLargerCallback
- exampleShortcutSmallerCallback
- exampleShortcutConflictionCallback

### UIç¤ºä¾‹(UI Examples)

![image](https://user-images.githubusercontent.com/33902321/211739774-cc5c2df8-5fd9-42f0-9cdf-0f2e5946d427.png)

- registerStyleSheet(the official make-it-red example)
- registerRightClickMenuItem
- registerRightClickMenuPopup
- registerWindowMenuWithSeprator
- registerExtraColumn
- registerExtraColumnWithCustomCell
- registerCustomItemBoxRow
- registerLibraryTabPanel
- registerReaderTabPanel

### é¦–é€‰é¡¹é¢æ¿ç¤ºä¾‹(Preference Pane Examples)

![image](https://user-images.githubusercontent.com/33902321/211737987-cd7c5c87-9177-4159-b975-dc67690d0490.png)

- Preferences bindings
- UI Events
- Table
- Locale

è¯¦æƒ…å‚è§ [`src/modules/preferenceScript.ts`](./src/modules/preferenceScript.ts)

### å¸®åŠ©ç¤ºä¾‹(HelperExamples)

![image](https://user-images.githubusercontent.com/33902321/215119473-e7d0d0ef-6d96-437e-b989-4805ffcde6cf.png)

- dialogExample
- clipboardExample
- filePickerExample
- progressWindowExample
- vtableExample(See Preference Pane Examples)

### æŒ‡ä»¤è¡Œç¤ºä¾‹(PromptExamples)

Obsidiané£æ ¼çš„æŒ‡ä»¤è¾“å…¥æ¨¡å—ï¼Œå®ƒé€šè¿‡æ¥å—æ–‡æœ¬æ¥è¿è¡Œæ’ä»¶ï¼Œå¹¶åœ¨å¼¹å‡ºçª—å£ä¸­æ˜¾ç¤ºå¯é€‰é¡¹.

ä½¿ç”¨ `Shift+P` æ¿€æ´».

![image](https://user-images.githubusercontent.com/33902321/215120009-e7c7ed27-33a0-44fe-b021-06c272481a92.png)

- registerAlertPromptExample

## å¿«é€Ÿä¸Šæ‰‹

### 0 ç¯å¢ƒè¦æ±‚

1. å®‰è£… [beta ç‰ˆ Zotero](https://www.zotero.org/support/beta_builds)
2. å®‰è£… [Node.js](https://nodejs.org/en/) å’Œ [Git](https://git-scm.com/)

> [!note]
> æœ¬æŒ‡å—å‡å®šä½ å·²ç»å¯¹ Zotero æ’ä»¶çš„åŸºæœ¬ç»“æ„å’Œå·¥ä½œåŸç†æœ‰åˆæ­¥çš„äº†è§£. å¦‚æœä½ è¿˜ä¸äº†è§£ï¼Œè¯·å…ˆå‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://www.zotero.org/support/dev/zotero_7_for_developers) å’Œ[å®˜æ–¹æ’ä»¶æ ·ä¾‹ Make It Red](https://github.com/zotero/make-it-red)ã€‚

### 1 åˆ›å»ºä½ çš„ä»“åº“(Create Your Repo)

1. ç‚¹å‡» `Use this template`ï¼›
2. ä½¿ç”¨ `git clone` å…‹éš†ä¸Šä¸€æ­¥ç”Ÿæˆçš„ä»“åº“ï¼›
   <details >
   <summary>ğŸ’¡ ä» GitHub Codespace å¼€å§‹</summary>

   _GitHub CodeSpace_ ä½¿ä½ å¯ä»¥ç›´æ¥å¼€å§‹å¼€å‘è€Œæ— éœ€åœ¨æœ¬åœ°ä¸‹è½½ä»£ç /IDE/ä¾èµ–.

   é‡å¤ä¸‹åˆ—æ­¥éª¤ï¼Œä»…éœ€ä¸‰åç§’å³å¯å¼€å§‹æ„å»ºä½ çš„ç¬¬ä¸€ä¸ªæ’ä»¶ï¼

   - ç‚¹å‡»é¦–é¡µ `Use this template` æŒ‰é’®ï¼Œéšåç‚¹å‡» `Open in codespace`ï¼Œ ä½ éœ€è¦ç™»å½•ä½ çš„ GitHub è´¦å·.
   - ç­‰å¾… codespace åŠ è½½.

   </details>

3. è¿›å…¥é¡¹ç›®æ–‡ä»¶å¤¹ï¼›

### 2 é…ç½®æ¨¡æ¿å’Œå¼€å‘ç¯å¢ƒ(Config Template Settings and Enviroment)

1. ä¿®æ”¹ `./package.json` ä¸­çš„è®¾ç½®ï¼ŒåŒ…æ‹¬ï¼š

   ```json5
   {
     version: "", // ä¿®æ”¹ä¸º 0.0.0
     author: "",
     description: "",
     homepage: "",
     config: {
       addonName: "", // æ’ä»¶åç§°
       addonID: "", // æ’ä»¶ ID ã€é‡è¦ï¼šé˜²æ­¢å†²çªã€‘
       addonRef: "", // æ’ä»¶å‘½åç©ºé—´ï¼šå…ƒç´ å‰ç¼€ç­‰
       addonInstance: "", // æ³¨å†Œåœ¨ Zotero æ ¹ä¸‹çš„å®ä¾‹å
       prefsPrefix: "extensions.zotero.${addonRef}", // é¦–é€‰é¡¹çš„å‰ç¼€
     },
   }
   ```

   > [!warning]
   > æ³¨æ„è®¾ç½® addonID å’Œ addonRef ä»¥é¿å…å†²çª.

   å¦‚æœä½ éœ€è¦åœ¨ GitHub ä»¥å¤–çš„åœ°æ–¹æ‰˜ç®¡ä½ çš„ XPI åŒ…ï¼Œè¯·ä¿®æ”¹ `zotero-plugin.config.ts` ä¸­çš„ `updateURL` å’Œ `xpiDownloadLink`ã€‚

2. å¤åˆ¶ Zotero å¯åŠ¨é…ç½®ï¼Œå¡«å…¥ Zotero å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„å’Œ profile è·¯å¾„.

   > (å¯é€‰é¡¹) åˆ›å»ºå¼€å‘ç”¨ profile ç›®å½•ï¼š
   >
   > æ­¤æ“ä½œä»…éœ€æ‰§è¡Œä¸€æ¬¡: ä½¿ç”¨ `/path/to/zotero -p` å¯åŠ¨ Zoteroï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„é…ç½®æ–‡ä»¶å¹¶ç”¨ä½œå¼€å‘é…ç½®æ–‡ä»¶ã€‚

   ```sh
   cp .env.example .env
   vim .env
   ```

   å¦‚æœä½ ç»´æŠ¤äº†å¤šä¸ªæ’ä»¶ï¼Œå¯ä»¥å°†è¿™äº›å†…å®¹å­˜å…¥ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œä»¥é¿å…åœ¨æ¯ä¸ªæ’ä»¶ä¸­éƒ½éœ€è¦é‡å¤è®¾ç½®ã€‚

3. è¿è¡Œ `npm install` ä»¥å®‰è£…ç›¸å…³ä¾èµ–

   > å¦‚æœä½ ä½¿ç”¨ `pnpm` ä½œä¸ºåŒ…ç®¡ç†å™¨ï¼Œä½ éœ€è¦æ·»åŠ  `public-hoist-pattern[]=*@types/bluebird*` åˆ°`.npmrc`, è¯¦æƒ…è¯·æŸ¥çœ‹ [zotero-types](https://github.com/windingwind/zotero-types?tab=readme-ov-file#usage) çš„æ–‡æ¡£.

   å¦‚æœä½ ä½¿ç”¨ `npm install` çš„è¿‡ç¨‹ä¸­é‡åˆ°äº† `npm ERR! ERESOLVE unable to resolve dependency tree` ï¼Œè¿™æ˜¯ç”±äºä¸Šæ¸¸ä¾èµ– typescript-eslint å¯¼è‡´çš„é”™è¯¯ï¼Œè¯·ä½¿ç”¨ `npm i -f` å‘½ä»¤è¿›è¡Œå®‰è£…ã€‚

### 3 å¼€å‘æ’ä»¶

ä½¿ç”¨ `npm start` å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼Œå®ƒå°†ï¼š

- åœ¨å¼€å‘æ¨¡å¼ä¸‹é¢„æ„å»ºæ’ä»¶
- å¯åŠ¨ Zotero ï¼Œå¹¶è®©å…¶ä» `build/` ä¸­åŠ è½½æ’ä»¶
- æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆdevtoolï¼‰
- ç›‘å¬ `src/**` å’Œ `addon/**`.
  - å¦‚æœ `src/**` ä¿®æ”¹äº†ï¼Œè¿è¡Œ esbuild å¹¶ä¸”é‡æ–°åŠ è½½
  - å¦‚æœ `addon/**` ä¿®æ”¹äº†ï¼Œ(åœ¨å¼€å‘æ¨¡å¼ä¸‹)é‡æ–°æ„å»ºæ’ä»¶å¹¶ä¸”é‡æ–°åŠ è½½

#### è‡ªåŠ¨çƒ­é‡è½½

åŒå€¦äº†æ— ä¼‘æ­¢çš„é‡å¯å—ï¼Ÿå¿˜æ‰å®ƒï¼Œæ‹¥æŠ±çƒ­åŠ è½½ï¼

1. è¿è¡Œ `npm start`.
2. ç¼–ç . (æ˜¯çš„ï¼Œå°±è¿™ä¹ˆç®€å•)

å½“æ£€æµ‹åˆ° `src` æˆ– `addon` ä¸­çš„æ–‡ä»¶ä¿®æ”¹æ—¶ï¼Œæ’ä»¶å°†è‡ªåŠ¨ç¼–è¯‘å¹¶é‡æ–°åŠ è½½.

<details style="text-indent: 2em">
<summary>ğŸ’¡ å°†æ­¤åŠŸèƒ½æ·»åŠ åˆ°ç°æœ‰æ’ä»¶çš„æ­¥éª¤</summary>

è¯·å‚é˜…ï¼š[zotero-plugin-scaffold](https://github.com/northword/zotero-plugin-scaffold)ã€‚

</details>

#### è°ƒè¯•ä»£ç 

ä½ è¿˜å¯ä»¥:

- åœ¨ Tools->Developer->Run Javascript ä¸­æµ‹è¯•ä»£ç ç‰‡æ®µ;

- ä½¿ç”¨ `Zotero.debug()` è°ƒè¯•è¾“å‡º. åœ¨ Help->Debug Output Logging->View Output æŸ¥çœ‹è¾“å‡º;

- è°ƒè¯• UI. Zotero å»ºç«‹åœ¨ Firefox XUL æ¡†æ¶ä¹‹ä¸Š. ä½¿ç”¨ [XUL Explorer](https://udn.realityripple.com/docs/Archive/Mozilla/XUL_Explorer) ç­‰è½¯ä»¶è°ƒè¯• XUL UI.

  > XUL æ–‡æ¡£: <http://www.devdoc.net/web/developer.mozilla.org/en-US/docs/XUL.html>

### 4 æ„å»ºæ’ä»¶

è¿è¡Œ `npm run build` åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹æ„å»ºæ’ä»¶ï¼Œæ„å»ºçš„ç»“æœä½äº `build/` ç›®å½•ä¸­.

æ„å»ºæ­¥éª¤:

- åˆ›å»º/æ¸…ç©º `build/`
- å¤åˆ¶ `addon/**` åˆ° `build/addon/**`
- æ›¿æ¢å ä½ç¬¦ï¼šä½¿ç”¨ `replace-in-file` å»æ›¿æ¢åœ¨ `package.json` ä¸­å®šä¹‰çš„å…³é”®å­—å’Œé…ç½® (`xhtml`ã€`.flt` ç­‰)
- å‡†å¤‡æœ¬åœ°åŒ–æ–‡ä»¶ä»¥é¿å…å†²çªï¼ŒæŸ¥çœ‹å®˜æ–¹æ–‡æ¡£äº†è§£æ›´å¤šï¼ˆ<https://www.zotero.org/support/dev/zotero_7_for_developers#avoiding_localization_conflictsï¼‰>
  - é‡å‘½å`**/*.flt` ä¸º `**/${addonRef}-*.flt`
  - åœ¨æ¯ä¸ªæ¶ˆæ¯å‰åŠ ä¸Š `addonRef-`
- ä½¿ç”¨ Esbuild æ¥å°† `.ts` æºç æ„å»ºä¸º `.js`ï¼Œä» `src/index.ts` æ„å»ºåˆ°`./build/addon/chrome/content/scripts`
- (ä»…åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹å·¥ä½œ) å‹ç¼© `./build/addon` ç›®å½•ä¸º `./build/*.xpi`
- (ä»…åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹å·¥ä½œ) å‡†å¤‡ `update.json` æˆ– `update-beta.json`

> [!note]
>
> **Dev & prod ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«?**
>
> - æ­¤ç¯å¢ƒå˜é‡å­˜å‚¨åœ¨ `Zotero.${addonInstance}.data.env` ä¸­ï¼Œæ§åˆ¶å°è¾“å‡ºåœ¨ç”Ÿäº§æ¨¡å¼ä¸‹è¢«ç¦ç”¨.
> - ä½ å¯ä»¥æ ¹æ®æ­¤å˜é‡å†³å®šç”¨æˆ·æ— æ³•æŸ¥çœ‹/ä½¿ç”¨çš„å†…å®¹.
> - åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œæ„å»ºè„šæœ¬å°†è‡ªåŠ¨æ‰“åŒ…æ’ä»¶å¹¶æ›´æ–° `update.json`.

### 5 å‘å¸ƒ

å¦‚æœè¦æ„å»ºå’Œå‘å¸ƒæ’ä»¶ï¼Œè¿è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š

```shell
# version increase, git add, commit and push
# then on ci, npm run build, and release to GitHub
npm run release
```

> [!note]
> åœ¨æ­¤æ¨¡æ¿ä¸­ï¼Œrelease-it è¢«é…ç½®ä¸ºåœ¨æœ¬åœ°æ›´æ–°ç‰ˆæœ¬å·ã€æäº¤å¹¶æ¨é€æ ‡ç­¾ï¼Œéšå GitHub Action å°†é‡æ–°æ„å»ºæ’ä»¶å¹¶å°† XPI å‘å¸ƒåˆ° GitHub Release.

#### å…³äºé¢„å‘å¸ƒ

è¯¥æ¨¡æ¿å°† `prerelease` å®šä¹‰ä¸ºæ’ä»¶çš„æµ‹è¯•ç‰ˆï¼Œå½“ä½ åœ¨ release-it ä¸­é€‰æ‹© `prerelease` ç‰ˆæœ¬ (ç‰ˆæœ¬å·ä¸­å¸¦æœ‰ `-` )ï¼Œæ„å»ºè„šæœ¬å°†åˆ›å»ºä¸€ä¸ª `update-beta.json` ç»™é¢„å‘å¸ƒç‰ˆæœ¬ä½¿ç”¨ï¼Œè¿™å°†ç¡®ä¿å¸¸è§„ç‰ˆæœ¬çš„ç”¨æˆ·ä¸ä¼šè‡ªåŠ¨æ›´æ–°åˆ°æµ‹è¯•ç‰ˆï¼Œåªæœ‰æ‰‹åŠ¨ä¸‹è½½å¹¶å®‰è£…äº†æµ‹è¯•ç‰ˆçš„ç”¨æˆ·æ‰èƒ½è‡ªåŠ¨æ›´æ–°åˆ°ä¸‹ä¸€ä¸ªæµ‹è¯•ç‰ˆ. å½“ä¸‹ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬æ›´æ–°æ—¶ï¼Œè„šæœ¬å°†åŒæ­¥æ›´æ–° `update.json` å’Œ `update-beta.json`ï¼Œè¿™å°†ä½¿æ­£å¼ç‰ˆå’Œæµ‹è¯•ç‰ˆç”¨æˆ·éƒ½å¯ä»¥æ›´æ–°åˆ°æœ€æ–°çš„æ­£å¼ç‰ˆ.

> [!warning]
> ä¸¥æ ¼æ¥è¯´ï¼ŒåŒºåˆ† Zotero 6 å’Œ Zotero 7 å…¼å®¹çš„æ’ä»¶ç‰ˆæœ¬åº”è¯¥é€šè¿‡ `update.json` çš„ `addons.__addonID__.updates[]` ä¸­åˆ†åˆ«é…ç½® `applications.zotero.strict_min_version`ï¼Œè¿™æ · Zotero æ‰èƒ½æ­£ç¡®è¯†åˆ«ï¼Œè¯¦æƒ…åœ¨ Zotero 7 å¼€å‘æ–‡æ¡£ï¼ˆ<https://www.zotero.org/support/dev/zotero_7_for_developers#updaterdf_updatesjsonï¼‰è·å–>.

## Details æ›´å¤šç»†èŠ‚

### å…³äºHooks(About Hooks)

> å¯ä»¥åœ¨ [`src/hooks.ts`](https://github.com/windingwind/zotero-plugin-template/blob/main/src/hooks.ts) ä¸­æŸ¥çœ‹æ›´å¤š

1. å½“åœ¨ Zotero ä¸­è§¦å‘å®‰è£…/å¯ç”¨/å¯åŠ¨æ—¶ï¼Œ`bootstrap.js` > `startup` è¢«è°ƒç”¨
   - ç­‰å¾… Zotero å°±ç»ª
   - åŠ è½½ `index.js` (æ’ä»¶ä»£ç çš„ä¸»å…¥å£ï¼Œä» `index.ts` ä¸­æ„å»º)
   - å¦‚æœæ˜¯ Zotero 7 ä»¥ä¸Šçš„ç‰ˆæœ¬åˆ™æ³¨å†Œèµ„æº
2. ä¸»å…¥å£ `index.js` ä¸­ï¼Œæ’ä»¶å¯¹è±¡è¢«æ³¨å…¥åˆ° `Zotero` ï¼Œå¹¶ä¸” `hooks.ts` > `onStartup` è¢«è°ƒç”¨.
   - åˆå§‹åŒ–æ’ä»¶éœ€è¦çš„èµ„æºï¼ŒåŒ…æ‹¬é€šçŸ¥ç›‘å¬å™¨ã€é¦–é€‰é¡¹é¢æ¿å’ŒUIå…ƒç´ .
3. å½“åœ¨ Zotero ä¸­è§¦å‘å¸è½½/ç¦ç”¨æ—¶ï¼Œ`bootstrap.js` > `shutdown` è¢«è°ƒç”¨.
   - `events.ts` > `onShutdown` è¢«è°ƒç”¨. ç§»é™¤ UI å…ƒç´ ã€é¦–é€‰é¡¹é¢æ¿æˆ–æ’ä»¶åˆ›å»ºçš„ä»»ä½•å†…å®¹.
   - ç§»é™¤è„šæœ¬å¹¶é‡Šæ”¾èµ„æº.

### å…³äºå…¨å±€å˜é‡(About Global Variables)

> å¯ä»¥åœ¨ [`src/index.ts`](https://github.com/windingwind/zotero-plugin-template/blob/main/src/index.ts)ä¸­æŸ¥çœ‹æ›´å¤š

bootstrapæ’ä»¶åœ¨æ²™ç›’ä¸­è¿è¡Œï¼Œä½†æ²™ç›’ä¸­æ²¡æœ‰é»˜è®¤çš„å…¨å±€å˜é‡ï¼Œä¾‹å¦‚ `Zotero` æˆ– `window` ç­‰æˆ‘ä»¬æ›¾åœ¨overlayæ’ä»¶ç¯å¢ƒä¸­ä½¿ç”¨çš„å˜é‡.

æ­¤æ¨¡æ¿å°†ä»¥ä¸‹å˜é‡æ³¨å†Œåˆ°å…¨å±€èŒƒå›´:

```ts
Zotero, ZoteroPane, Zotero_Tabs, window, document, rootURI, ztoolkit, addon;
```

### åˆ›å»ºå…ƒç´  API(Create Elements API)

æ’ä»¶æ¨¡æ¿ä¸º bootstrap æ’ä»¶æä¾›äº†ä¸€äº›æ–°çš„API. æˆ‘ä»¬æœ‰ä¸¤ä¸ªåŸå› ä½¿ç”¨è¿™äº› APIï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `createElement/createElementNS`ï¼š

- åœ¨ bootstrap æ¨¡å¼ä¸‹ï¼Œæ’ä»¶å¿…é¡»åœ¨æ¨å‡ºï¼ˆç¦ç”¨æˆ–å¸è½½ï¼‰æ—¶æ¸…ç†æ‰€æœ‰ UI å…ƒç´ ï¼Œè¿™éå¸¸éº»çƒ¦. ä½¿ç”¨ `createElement`ï¼Œæ’ä»¶æ¨¡æ¿å°†ç»´æŠ¤è¿™äº›å…ƒç´ . ä»…ä»…åœ¨é€€å‡ºæ—¶ `unregisterAll` .
- Zotero 7 éœ€è¦ createElement()/createElementNS() â†’ createXULElement() æ¥è¡¨ç¤ºå…¶ä»–çš„ XUL å…ƒç´ ï¼Œè€Œ Zotero 6 å¹¶ä¸æ”¯æŒ `createXULElement`. ç±»ä¼¼äº React.createElement çš„API `createElement` æ£€æµ‹ namespace(xul/html/svg) å¹¶ä¸”è‡ªåŠ¨åˆ›å»ºå…ƒç´ ï¼Œè¿”å›å…ƒç´ ä¸ºå¯¹åº”çš„ TypeScript å…ƒç´ ç±»å‹.

```ts
createElement(document, "div"); // returns HTMLDivElement
createElement(document, "hbox"); // returns XUL.Box
createElement(document, "button", { namespace: "xul" }); // manually set namespace. returns XUL.Button
```

### å…³äº Zotero API(About Zotero API)

Zotero æ–‡æ¡£å·²è¿‡æ—¶ä¸”ä¸å®Œæ•´ï¼Œå…‹éš† <https://github.com/zotero/zotero> å¹¶å…¨å±€æœç´¢å…³é”®å­—.

> â­[zotero-types](https://github.com/windingwind/zotero-types) æä¾›äº†æœ€å¸¸ç”¨çš„ Zotero APIï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹å®ƒè¢«åŒ…å«åœ¨æ­¤æ¨¡æ¿ä¸­. ä½ çš„ IDE å°†ä¸ºå¤§å¤šæ•°çš„ API æä¾›æé†’.

çŒœä½ éœ€è¦ï¼šæŸ¥æ‰¾æ‰€éœ€ APIçš„æŠ€å·§

åœ¨ `.xhtml`/`.flt` æ–‡ä»¶ä¸­æœç´¢ UI æ ‡ç­¾ï¼Œç„¶ååœ¨ locale æ–‡ä»¶ä¸­æ‰¾åˆ°å¯¹åº”çš„é”®. ï¼Œç„¶ååœ¨ `.js`/`.jsx` æ–‡ä»¶ä¸­æœç´¢æ­¤é”®.

### ç›®å½•ç»“æ„(Directory Structure)

æœ¬éƒ¨åˆ†å±•ç¤ºäº†æ¨¡æ¿çš„ç›®å½•ç»“æ„.

- æ‰€æœ‰çš„ `.js/.ts` ä»£ç éƒ½åœ¨ `./src`;
- æ’ä»¶é…ç½®æ–‡ä»¶ï¼š`./addon/manifest.json`;
- UI æ–‡ä»¶: `./addon/chrome/content/*.xhtml`.
- åŒºåŸŸè®¾ç½®æ–‡ä»¶: `./addon/locale/**/*.flt`;
- é¦–é€‰é¡¹æ–‡ä»¶: `./addon/prefs.js`;
  > ä¸è¦åœ¨ `prefs.js` ä¸­æ¢è¡Œ

```shell
.
|-- .eslintrc.json            # eslint conf
|-- .gitattributes            # git conf
|-- .github/                  # github conf
|-- .gitignore                # git conf
|-- .prettierrc               # prettier conf
|-- .release-it.json          # release-it conf
|-- .vscode                   # vs code conf
|   |-- extensions.json
|   |-- launch.json
|   |-- setting.json
|   `-- toolkit.code-snippets
|-- package-lock.json         # npm conf
|-- package.json              # npm conf
|-- LICENSE
|-- README.md
|-- addon
|   |-- bootstrap.js               # addon load/unload script, like a main.c
|   |-- chrome
|   |   `-- content
|   |       |-- icons/
|   |       |-- preferences.xhtml  # preference panel
|   |       `-- zoteroPane.css
|   |-- locale                     # locale
|   |   |-- en-US
|   |   |   |-- addon.ftl
|   |   |   `-- preferences.ftl
|   |   `-- zh-CN
|   |       |-- addon.ftl
|   |       `-- preferences.ftl
|   |-- manifest.json              # addon config
|   `-- prefs.js
|-- build/                         # build dir
|-- scripts                        # scripts for dev
|   |-- build.mjs                      # script to build plugin
|   |-- scripts.mjs                    # scripts send to Zotero, such as reload, openDevTool, etc
|   |-- server.mjs                     # script to start a development server
|   |-- start.mjs                      # script to start Zotero process
|   |-- stop.mjs                       # script to kill Zotero process
|   |-- utils.mjs                      # utils functions for dev scripts
|   |-- update-template.json      # template of `update.json`
|   `-- zotero-cmd-template.json  # template of local env
|-- src                           # source code
|   |-- addon.ts                  # base class
|   |-- hooks.ts                  # lifecycle hooks
|   |-- index.ts                  # main entry
|   |-- modules                   # sub modules
|   |   |-- examples.ts
|   |   `-- preferenceScript.ts
|   `-- utils                     # utilities
|       |-- locale.ts
|       |-- prefs.ts
|       |-- wait.ts
|       `-- window.ts
|-- tsconfig.json                 # https://code.visualstudio.com/docs/languages/jsconfig
|-- typings                       # ts typings
|   `-- global.d.ts
`-- update.json
```

## Disclaimer å…è´£å£°æ˜

åœ¨ AGPL ä¸‹ä½¿ç”¨æ­¤ä»£ç . ä¸æä¾›ä»»ä½•ä¿è¯. éµå®ˆä½ æ‰€åœ¨åœ°åŒºçš„æ³•å¾‹ï¼

å¦‚æœä½ æƒ³æ›´æ”¹è®¸å¯ï¼Œè¯·é€šè¿‡ <wyzlshx@foxmail.com> ä¸æˆ‘è”ç³».
