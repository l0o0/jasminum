<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="chrome://global/skin/" type="text/css"?> <?xml-stylesheet
href="chrome://zotero/skin/zotero.css" type="text/css"?> <?xml-stylesheet
href="chrome://zotero-platform/content/zotero-react-client.css"
type="text/css"?> <?xml-stylesheet
href="chrome://zotero-platform/content/zotero.css" type="text/css"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æŠ“å–ä»»åŠ¡åˆ—è¡¨</title>
    <style>
      /* é»˜è®¤æ ·å¼ï¼ˆLight Modeï¼‰ */
      html {
        height: 100%;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 8px;
        padding: 8px;
        border-radius: 4px;
        background-color: #ffffff;
        color: #000000;
        height: 334px;
      }

      .task {
        margin-bottom: 10px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        background-color: #f9f9f9;
      }

      .task-header {
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .task-status {
        margin-right: 10px;
        font-size: 20px;
      }

      .task-title {
        font-weight: bold;
        flex-grow: 1;
      }

      .toggle-icon {
        margin-left: 10px;
        font-size: 14px;
        transition: transform 0.2s;
      }

      .search-results-container {
        display: flex;
        align-items: flex-start; /* ç¡®ä¿æŒ‰é’®å’Œæœç´¢ç»“æœå¯¹é½ */
        margin-left: 20px;
        margin-top: 10px;
      }

      .confirm-button {
        margin-right: 10px; /* æŒ‰é’®æ”¾åœ¨æœç´¢ç»“æœå·¦ä¾§ */
        padding: 5px 10px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        display: none; /* é»˜è®¤éšè— */
      }

      .confirm-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .search-results {
        flex-grow: 1; /* æœç´¢ç»“æœå æ®å‰©ä½™ç©ºé—´ */
      }

      .search-result {
        margin-bottom: 5px;
        padding: 5px;
        border: 1px solid #eee;
        border-radius: 3px;
        background-color: #ffffff;
        display: flex;
        align-items: center;
      }

      .search-result input[type="radio"] {
        margin-right: 10px;
      }

      .search-result .info {
        flex-grow: 1;
      }

      .search-result .source {
        color: #666;
        font-size: 0.9em;
      }

      .search-result .title {
        font-weight: bold;
      }

      .task.completed .search-result input[type="radio"] {
        pointer-events: none; /* ç¦ç”¨å•é€‰æŒ‰é’® */
        opacity: 0.5; /* é™ä½é€æ˜åº¦ */
      }

      div.buttons {
        position: absolute;
        bottom: 2px; /* å›ºå®šåœ¨åº•éƒ¨ */
        right: 20px; /* å›ºå®šåœ¨å³ä¾§ */
        padding: 8px; /* å†…è¾¹è· */
        /* background-color: #f9f9f9; èƒŒæ™¯è‰² */
        /* border-top: 1px solid #ccc; é¡¶éƒ¨è¾¹æ¡† */
        display: flex;
        gap: 10px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
      }

      .task-msg {
        width: 14px;
        margin-left: 8px;
      }

      /* é»‘æš—æ¨¡å¼æ ·å¼ */
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #121212;
          color: #e0e0e0;
        }

        .task {
          background-color: #1e1e1e;
          border-color: #444;
        }

        .search-result,
        div.buttons {
          background-color: #2d2d2d;
          border-color: #444;
        }

        .search-result .source {
          color: #999;
        }

        .search-result .title {
          color: #e0e0e0;
        }

        .task-status {
          color: #e0e0e0;
        }

        .task-title,
        div.buttons {
          color: #e0e0e0;
        }

        .toggle-icon {
          color: #e0e0e0;
        }

        .confirm-button {
          background-color: #4caf50;
        }

        .confirm-button:disabled {
          background-color: #666;
        }
      }
    </style>
  </head>
  <body>
    <h1>æŠ“å–ä»»åŠ¡åˆ—è¡¨</h1>
    <div id="task-list"></div>
    <div class="buttons">
      <button id="button-cancel">Close</button>
      <button id="button-ok" style="display: none">OK</button>
    </div>
  </body>
  <script>
    //<![CDATA[
    if (window.arguments) {
      document.addEventListener("DOMContentLoaded", (ev) => {
        Services.scriptloader.loadSubScript(
          "chrome://zotero/content/include.js",
          this,
        );

        Services.scriptloader.loadSubScript(
          "resource://zotero/require.js",
          this,
        );

        window.arguments[0]._initPromise.resolve();
      });
    }

    // æ¨¡æ‹Ÿæ•°æ®
    const tasks = [
      {
        id: "1",
        type: "attachment",
        item: { getField: () => "è®ºæ–‡æ ‡é¢˜ 1" },
        status: "success",
        errorMsg: "This is error msg1",
        searchResult: [
          {
            source: "Source A",
            title: "Result 1",
            url: "https://example.com/1",
          },
          {
            source: "Source B",
            title: "Result 2",
            url: "https://example.com/2",
          },
        ],
      },
      {
        id: "2",
        type: "snapshot",
        item: { getField: () => "è®ºæ–‡æ ‡é¢˜ 2" },
        status: "processing",
        errorMsg: "This is error msg2",
      },
      {
        id: "3",
        type: "attachment",
        item: { getField: () => "è®ºæ–‡æ ‡é¢˜ 3" },
        status: "fail",
        errorMsg: "æŠ“å–å¤±è´¥",
      },
    ];

    // çŠ¶æ€å›¾æ ‡æ˜ å°„
    const statusIcons = {
      waiting: "â³",
      processing: "ğŸ”„",
      multiple_results: "ğŸ”",
      success: "âœ…",
      fail: "âŒ",
    };

    // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
    function renderTaskList(tasks) {
      const taskList = document.getElementById("task-list");
      if (!taskList) return;

      taskList.innerHTML = tasks
        .map(
          (task) => `
            <div class="task" data-task-id="${task.id}">
              <div class="task-header">
                <span class="task-status">${statusIcons[task.status]}</span>
                <span class="task-title">${task.item.getField("title")}</span>
                <span class="task-msg" id="task-msg-${task.id}" title="${task.errorMsg}">âš ï¸</span>
                ${
                  task.searchResult && task.searchResult.length > 0
                    ? `<span class="toggle-icon" id="toggle-icon-${task.id}">â–¼</span>`
                    : ""
                }
              </div>
              ${
                task.searchResult && task.searchResult.length > 0
                  ? `
                    <div class="search-results-container" id="search-results-container-${task.id}">
                      <button class="confirm-button" data-task-id="${task.id}">ç¡®è®¤</button>
                      <div class="search-results" id="search-results-${task.id}">
                        ${task.searchResult
                          .map(
                            (result, index) => `
                              <div class="search-result">
                                <input type="radio" name="task-${task.id}" data-task-id="${task.id}" data-result-index="${index}" />
                                <div class="info">
                                  <span class="source">æ¥æº: ${result.source}</span>
                                  <span class="title">æ ‡é¢˜: ${result.title}</span>
                                </div>
                              </div>
                            `,
                          )
                          .join("")}
                      </div>
                    </div>
                  `
                  : ""
              }
            </div>
          `,
        )
        .join("");
    }

    // åˆ‡æ¢æœç´¢ç»“æœçš„æ˜¾ç¤º/éšè—
    function toggleSearchResults(taskId) {
      const searchResultsContainer = document.getElementById(
        `search-results-container-${taskId}`,
      );
      const toggleIcon = document.getElementById(`toggle-icon-${taskId}`);
      console.log("click", `#search-results-container-${taskId}`);
      if (searchResultsContainer && toggleIcon) {
        if (searchResultsContainer.style.display === "none") {
          searchResultsContainer.style.display = "";
          toggleIcon.textContent = "â–²"; // å±•å¼€æ—¶æ˜¾ç¤ºå‘ä¸Šç®­å¤´
        } else {
          searchResultsContainer.style.display = "none";
          toggleIcon.textContent = "â–¼"; // æ”¶èµ·æ—¶æ˜¾ç¤ºå‘ä¸‹ç®­å¤´
        }
      }
    }

    // äº‹ä»¶å§”æ‰˜ï¼šç»‘å®šç‚¹å‡»äº‹ä»¶
    document.getElementById("task-list").addEventListener("click", (event) => {
      console.log("click", event.target);
      const taskHeader = event.target.closest(".task-header");
      if (taskHeader) {
        const taskId = taskHeader.closest(".task").getAttribute("data-task-id");
        toggleSearchResults(taskId);
      }

      const radio = event.target.closest('input[type="radio"]');
      if (radio) {
        const taskId = radio.getAttribute("data-task-id");
        const confirmButton = document.querySelector(
          `.confirm-button[data-task-id="${taskId}"]`,
        );
        if (confirmButton) {
          confirmButton.style.display = radio.checked ? "inline-block" : "none";
        }
      }

      const confirmButton = event.target.closest(".confirm-button");
      if (confirmButton) {
        const taskId = confirmButton.getAttribute("data-task-id");
        const selectedRadio = document.querySelector(
          `input[type="radio"][data-task-id="${taskId}"]:checked`,
        );
        if (selectedRadio) {
          const resultIndex = selectedRadio.getAttribute("data-result-index");
          console.log(`å·²ç¡®è®¤é€‰æ‹©ï¼š${taskId} (${resultIndex})`);
          const targetTask = Zotero.Jasminum.data.progress.taskList.filter(
            (task) => task.id === taskId,
          )[0];
          targetTask.resultIndex = resultIndex;
          Zotero.Jasminum.scraper.translate(targetTask);

          // æ ‡è®°ä»»åŠ¡ä¸ºå·²å®Œæˆ
          const taskElement = confirmButton.closest(".task");
          taskElement.classList.add("completed");

          // ç¦ç”¨æ‰€æœ‰å•é€‰æŒ‰é’®
          const radios = taskElement.querySelectorAll('input[type="radio"]');
          radios.forEach((radio) => {
            radio.disabled = true;
          });

          // éšè—ç¡®è®¤æŒ‰é’®
          confirmButton.style.display = "none";
        }
      }
    });

    document.getElementById("button-cancel").addEventListener("click", (e) => {
      console.log(e);
      const unfinishedTasks = Zotero.Jasminum.data.progress.taskList.filter(
        (t) => t.status != "fail" && t.status != "success",
      );
      if (unfinishedTasks.length > 0) {
        const userConfirmed = confirm(
          `è¿˜æœ‰ ${unfinishedTasks.length} ä¸ªæŠ“å–ä»»åŠ¡ï¼Œæ˜¯å¦å…³é—­çª—å£ï¼Ÿ`,
        );
        if (userConfirmed) {
          window.close();
        }
      } else {
        window.close();
      }
    });

    // åˆå§‹åŒ–æ¸²æŸ“
    if (window.arguments == undefined) {
      renderTaskList(tasks);
      // é»˜è®¤å±•å¼€æœ‰å¤šä¸ªæœç´¢ç»“æœçš„ä»»åŠ¡
      tasks.forEach((task) => {
        if (task.searchResult && task.searchResult.length > 0) {
          const searchResults = document.getElementById(
            `search-results-${task.id}`,
          );
          const toggleIcon = document.getElementById(`toggle-icon-${task.id}`);
          if (searchResults && toggleIcon) {
            searchResults.style.display = "block"; // é»˜è®¤å±•å¼€
            toggleIcon.textContent = "â–²"; // é»˜è®¤æ˜¾ç¤ºå‘ä¸Šç®­å¤´
          }
        }
      });
    }
    //]]>
  </script>
</html>
