<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="chrome://global/skin/" type="text/css"?> <?xml-stylesheet
href="chrome://zotero/skin/zotero.css" type="text/css"?> <?xml-stylesheet
href="chrome://zotero-platform/content/zotero-react-client.css"
type="text/css"?> <?xml-stylesheet
href="chrome://zotero-platform/content/zotero.css" type="text/css"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
  xmlns:html="http://www.w3.org/1999/xhtml"
>
  <head>
    <meta charset="UTF-8" />
    <xul:linkset>
      <link rel="localization" href="__addonRef__-progress.ftl" />
    </xul:linkset>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-l10n-id="title"></title>
    <style>
      /* é»˜è®¤æ ·å¼ï¼ˆLight Modeï¼‰ */
      html {
        height: 100%;
      }

      body {
        display: flex;
        flex-direction: column;
        font-family: Arial, sans-serif;
        padding: 8px 8px 40px; /* åº•éƒ¨ç•™å‡ºæŒ‰é’®ç©ºé—´ */
        box-sizing: border-box; /* ç¡®ä¿å°ºå¯¸è®¡ç®—åŒ…å«padding */
        border-radius: 4px;
        background-color: #ffffff;
        color: #000000;
        height: 90vh; /* ä½¿ç”¨è§†å£é«˜åº¦ */
      }

      h1 {
        flex-shrink: 0; /* ç¦æ­¢æ ‡é¢˜æ”¶ç¼© */
        margin: 0 0 10px 0;
      }

      /* å¯æ»šåŠ¨åŒºåŸŸ */
      #task-list {
        flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
        overflow-y: auto; /* å‚ç›´æ»šåŠ¨ */
        min-height: 0; /* å…è®¸å†…å®¹å‹ç¼© */
      }

      /* è°ƒæ•´åº•éƒ¨æŒ‰é’®å®šä½ */
      div.buttons {
        position: fixed;
        top: 332px;
        right: 35px;
        background: inherit; /* ç»§æ‰¿èƒŒæ™¯è‰² */
        border-radius: 4px;
      }

      div.hidden {
        display: none;
      }

      .task {
        margin-bottom: 10px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        background-color: #f9f9f9;
      }

      .task-header {
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .task-status {
        margin-right: 10px;
        font-size: 20px;
      }

      .task-title {
        font-weight: bold;
        flex-grow: 1;
      }

      .toggle-icon {
        margin-left: 10px;
        font-size: 14px;
        transition: transform 0.2s;
      }

      .search-results-container {
        display: flex;
        align-items: flex-start; /* ç¡®ä¿æŒ‰é’®å’Œæœç´¢ç»“æœå¯¹é½ */
        margin-left: 20px;
        margin-top: 10px;
      }

      .confirm-button {
        margin-right: 4px; /* æŒ‰é’®æ”¾åœ¨æœç´¢ç»“æœå·¦ä¾§ */
        margin-left: -20px;
        padding: 4px 8px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        display: none; /* é»˜è®¤éšè— */
        font-size: 12px;
        width: 50px;
        margin-top: 1.5px;
      }

      .confirm-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .search-results {
        flex-grow: 1; /* æœç´¢ç»“æœå æ®å‰©ä½™ç©ºé—´ */
      }

      .search-result {
        margin-bottom: 4px;
        padding: 4px;
        border: 1px solid #eee;
        border-radius: 3px;
        background-color: #ffffff;
        display: flex;
        align-items: center;
      }

      .search-result input[type="radio"] {
        margin-right: 8px;
      }

      .search-result .info {
        flex-grow: 1;
      }

      .search-result .source {
        color: #666;
        font-size: 0.9em;
      }

      .search-result .title {
        font-weight: bold;
      }

      .task.completed .search-result input[type="radio"] {
        pointer-events: none; /* ç¦ç”¨å•é€‰æŒ‰é’® */
        opacity: 0.5; /* é™ä½é€æ˜åº¦ */
      }

      .task-msg {
        width: 15px;
        margin-left: 8px;
        vertical-align: middle;
      }

      /* é»‘æš—æ¨¡å¼æ ·å¼ */
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #121212;
          color: #e0e0e0;
        }

        .task {
          background-color: #1e1e1e;
          border-color: #444;
        }

        .search-result,
        div.buttons {
          background-color: #2d2d2d;
          border-color: #444;
        }

        .search-result .source {
          color: #999;
        }

        .search-result .title {
          color: #e0e0e0;
        }

        .task-status {
          color: #e0e0e0;
        }

        .task-title,
        div.buttons {
          color: #e0e0e0;
        }

        .toggle-icon {
          color: #e0e0e0;
        }

        .confirm-button {
          background-color: #4caf50;
        }

        .confirm-button:disabled {
          background-color: #666;
        }
      }
    </style>
  </head>
  <body>
    <h1 data-l10n-id="task-list"></h1>
    <div class="hidden">
      <p id="msg1" data-l10n-id="confirm-close"></p>
    </div>
    <div id="task-list"></div>
    <div class="buttons">
      <button id="button-cancel">Close</button>
      <button id="button-ok" style="display: none">OK</button>
    </div>
  </body>
  <script>
    //<![CDATA[
    if (window.arguments) {
      document.addEventListener("DOMContentLoaded", (ev) => {
        Services.scriptloader.loadSubScript(
          "chrome://zotero/content/include.js",
          this,
        );

        Services.scriptloader.loadSubScript(
          "resource://zotero/require.js",
          this,
        );

        window.arguments[0]._initPromise.resolve();
      });
    }

    // æ¨¡æ‹Ÿæ•°æ®
    const tasks = [
      {
        id: "1",
        type: "attachment",
        item: { getField: () => "è®ºæ–‡æ ‡é¢˜ 1" },
        status: "success",
        message: "This is error msg1",
        searchResult: [
          {
            source: "Source A",
            title: "Result 1",
            url: "https://example.com/1",
          },
          {
            source: "Source B",
            title: "Result 2",
            url: "https://example.com/2",
          },
        ],
      },
      {
        id: "2",
        type: "snapshot",
        item: { getField: () => "è®ºæ–‡æ ‡é¢˜ 2" },
        status: "processing",
        message: "This is error msg2",
      },
      {
        id: "3",
        type: "attachment",
        item: { getField: () => "è®ºæ–‡æ ‡é¢˜ 3" },
        status: "fail",
        message: "æŠ“å–å¤±è´¥",
      },
    ];

    // çŠ¶æ€å›¾æ ‡æ˜ å°„
    const statusIcons = {
      waiting: "â³",
      processing: "ğŸ”„",
      multiple_results: "ğŸ”",
      success: "âœ…",
      fail: "âŒ",
    };

    // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
    function renderTaskList(tasks) {
      const taskList = document.getElementById("task-list");
      if (!taskList) return;

      taskList.innerHTML = tasks
        .map(
          (task) => `
            <div class="task" data-task-id="${task.id}">
              <div class="task-header">
                <span class="task-status">${statusIcons[task.status]}</span>
                <span class="task-title">${task.item.getField("title")}</span>
                <span class="task-msg" id="task-msg-${task.id}" title="${task.message}">âš ï¸</span>
                ${
                  task.searchResult && task.searchResult.length > 0
                    ? `<span class="toggle-icon" id="toggle-icon-${task.id}">â–¼</span>`
                    : ""
                }
              </div>
              ${
                task.searchResult && task.searchResult.length > 0
                  ? `
                    <div class="search-results-container" id="search-results-container-${task.id}">
                      <button class="confirm-button" data-task-id="${task.id}">ç¡®è®¤</button>
                      <div class="search-results" id="search-results-${task.id}">
                        ${task.searchResult
                          .map(
                            (result, index) => `
                              <div class="search-result">
                                <input type="radio" name="task-${task.id}" data-task-id="${task.id}" data-result-index="${index}" />
                                <div class="info">
                                  <span class="source" data-l10n-id="result-source" data-l10n-args='{"source": "${result.source}"}'></span>
                                  <span class="title" data-l10n-id="result-title" data-l10n-args='{"title": "${result.title}"}'></span>
                                  <span class="score" data-l10n-id="result-score" data-l10n-args='{"score": "${result.score}"}'></span>
                                </div>
                              </div>
                            `,
                          )
                          .join("")}
                      </div>
                    </div>
                  `
                  : ""
              }
            </div>
          `,
        )
        .join("");
    }

    // åˆ‡æ¢æœç´¢ç»“æœçš„æ˜¾ç¤º/éšè—
    function toggleSearchResults(taskId) {
      const searchResultsContainer = document.getElementById(
        `search-results-container-${taskId}`,
      );
      const toggleIcon = document.getElementById(`toggle-icon-${taskId}`);
      console.log("click", `#search-results-container-${taskId}`);
      if (searchResultsContainer && toggleIcon) {
        if (searchResultsContainer.style.display === "none") {
          searchResultsContainer.style.display = "";
          toggleIcon.textContent = "â–²"; // å±•å¼€æ—¶æ˜¾ç¤ºå‘ä¸Šç®­å¤´
        } else {
          searchResultsContainer.style.display = "none";
          toggleIcon.textContent = "â–¼"; // æ”¶èµ·æ—¶æ˜¾ç¤ºå‘ä¸‹ç®­å¤´
        }
      }
    }

    // äº‹ä»¶å§”æ‰˜ï¼šç»‘å®šç‚¹å‡»äº‹ä»¶
    document.getElementById("task-list").addEventListener("click", (event) => {
      console.log("click", event.target);
      const taskHeader = event.target.closest(".task-header");
      if (taskHeader) {
        const taskId = taskHeader.closest(".task").getAttribute("data-task-id");
        toggleSearchResults(taskId);
      }

      const radio = event.target.closest('input[type="radio"]');
      if (radio) {
        const taskId = radio.getAttribute("data-task-id");
        const confirmButton = document.querySelector(
          `.confirm-button[data-task-id="${taskId}"]`,
        );
        if (confirmButton) {
          confirmButton.style.display = radio.checked ? "inline-block" : "none";
        }
      }

      const confirmButton = event.target.closest(".confirm-button");
      if (confirmButton) {
        const taskId = confirmButton.getAttribute("data-task-id");
        const selectedRadio = document.querySelector(
          `input[type="radio"][data-task-id="${taskId}"]:checked`,
        );
        if (selectedRadio) {
          const resultIndex = selectedRadio.getAttribute("data-result-index");
          console.log(`å·²ç¡®è®¤é€‰æ‹©ï¼š${taskId} (${resultIndex})`);
          Zotero.Jasminum.taskRunner.resumeTask(taskId, resultIndex);

          // æ ‡è®°ä»»åŠ¡ä¸ºå·²å®Œæˆ
          const taskElement = confirmButton.closest(".task");
          taskElement.classList.add("completed");

          // ç¦ç”¨æ‰€æœ‰å•é€‰æŒ‰é’®
          const radios = taskElement.querySelectorAll('input[type="radio"]');
          radios.forEach((radio) => {
            radio.disabled = true;
          });

          // éšè—ç¡®è®¤æŒ‰é’®
          confirmButton.style.display = "none";
        }
      }
    });

    document.getElementById("button-cancel").addEventListener("click", (e) => {
      console.log(e);
      const unfinishedTasks = Zotero.Jasminum.taskRunner.tasks.filter(
        (t) => t.status != "fail" && t.status != "success",
      );
      if (unfinishedTasks.length > 0) {
        const msg = document
          .getElementById("msg1")
          .textContent.replace("xxx", unfinishedTasks.length);
        const userConfirmed = confirm(msg);
        if (userConfirmed) {
          window.close();
        }
      } else {
        window.close();
      }
    });

    // åˆå§‹åŒ–æ¸²æŸ“
    if (window.arguments == undefined) {
      renderTaskList(tasks);
      // é»˜è®¤å±•å¼€æœ‰å¤šä¸ªæœç´¢ç»“æœçš„ä»»åŠ¡
      tasks.forEach((task) => {
        if (task.searchResult && task.searchResult.length > 0) {
          const searchResults = document.getElementById(
            `search-results-${task.id}`,
          );
          const toggleIcon = document.getElementById(`toggle-icon-${task.id}`);
          if (searchResults && toggleIcon) {
            searchResults.style.display = "block"; // é»˜è®¤å±•å¼€
            toggleIcon.textContent = "â–²"; // é»˜è®¤æ˜¾ç¤ºå‘ä¸Šç®­å¤´
          }
        }
      });
    }

    // window.addEventListener("DOMWindowClose", (e) => {
    //   const shouldClose = confirm("ç¡®å®šè¦å…³é—­çª—å£å—ï¼Ÿ");
    //   if (!shouldClose) {
    //     e.preventDefault(); // é˜»æ­¢å…³é—­
    //   }
    // });
    //]]>
  </script>
</html>
